<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pháo Hoa 60-20-20 Có Âm Thanh</title>
    <style>
        body {
            background: #000;
            margin: 0;
            overflow: hidden;
            cursor: crosshair;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>

    <canvas id="canvas"></canvas>

<script>
    // --- PHẦN ÂM THANH ---
    // Link âm thanh tiếng nổ online
    const explosionSoundURL = 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/127738/explosion03.mp3';
    
    function playSound() {
        // Tạo đối tượng âm thanh mới mỗi lần nổ để tiếng chồng lên nhau được tự nhiên
        var audio = new Audio(explosionSoundURL);
        audio.volume = 0.3; // Âm lượng vừa phải
        audio.play().catch(function(error) {
            // Trình duyệt chặn tự động phát nếu chưa click chuột
        });
    }

    // --- CẤU HÌNH CƠ BẢN ---
    window.requestAnimFrame = (function() {
        return window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            function(callback) { window.setTimeout(callback, 1000 / 60); };
    })();

    var canvas = document.getElementById('canvas'),
        ctx = canvas.getContext('2d'),
        cw = window.innerWidth,
        ch = window.innerHeight,
        fireworks = [],
        particles = [],
        hue = 120,
        limiterTotal = 5,
        limiterTick = 0,
        timerTotal = 40, 
        timerTick = 0,
        mousedown = false,
        mx, my;

    canvas.width = cw;
    canvas.height = ch;

    window.addEventListener('resize', function() {
        cw = window.innerWidth;
        ch = window.innerHeight;
        canvas.width = cw;
        canvas.height = ch;
    });

    function random(min, max) {
        return Math.random() * (max - min) + min;
    }

    function calculateDistance(p1x, p1y, p2x, p2y) {
        var xDistance = p1x - p2x,
            yDistance = p1y - p2y;
        return Math.sqrt(Math.pow(xDistance, 2) + Math.pow(yDistance, 2));
    }

    // --- LỚP PHÁO BAY LÊN ---
    function Firework(sx, sy, tx, ty, shapeType = null) {
        this.x = sx;
        this.y = sy;
        this.sx = sx;
        this.sy = sy;
        this.tx = tx;
        this.ty = ty;
        this.distanceToTarget = calculateDistance(sx, sy, tx, ty);
        this.distanceTraveled = 0;
        this.coordinates = [];
        this.coordinateCount = 3;
        while (this.coordinateCount--) {
            this.coordinates.push([this.x, this.y]);
        }
        this.angle = Math.atan2(ty - sy, tx - sx);
        this.speed = 2;
        this.acceleration = 1.05;
        this.brightness = random(50, 70);
        this.targetRadius = 1;
        this.shapeType = shapeType;
    }

    Firework.prototype.update = function(index) {
        this.coordinates.pop();
        this.coordinates.unshift([this.x, this.y]);

        if (this.targetRadius < 8) { this.targetRadius += 0.3; } else { this.targetRadius = 1; }
        this.speed *= this.acceleration;

        var vx = Math.cos(this.angle) * this.speed,
            vy = Math.sin(this.angle) * this.speed;
        this.distanceTraveled = calculateDistance(this.sx, this.sy, this.x + vx, this.y + vy);

        if (this.distanceTraveled >= this.distanceToTarget) {
            // GỌI HÀM ÂM THANH KHI NỔ
            playSound();
            
            // XỬ LÝ HÌNH DÁNG
            if (this.shapeType === 'heart') {
                createShapeParticles(this.tx, this.ty, getHeartPoints(3));
            } else if (this.shapeType === 'text') {
                createShapeParticles(this.tx, this.ty - 50, getTextPoints("CHÚC MỪNG NĂM MỚI", 30));
            } else {
                createParticles(this.tx, this.ty);
            }
            fireworks.splice(index, 1);
        } else {
            this.x += vx;
            this.y += vy;
        }
    }

    Firework.prototype.draw = function() {
        ctx.beginPath();
        ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
        ctx.lineTo(this.x, this.y);
        ctx.strokeStyle = 'hsl(' + hue + ', 100%, ' + this.brightness + '%)';
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(this.tx, this.ty, this.targetRadius, 0, Math.PI * 2);
        ctx.stroke();
    }

    // --- LỚP HẠT NỔ (VẬT LÝ RƠI CHẬM) ---
    function Particle(x, y) {
        this.x = x;
        this.y = y;
        this.coordinates = [];
        this.coordinateCount = 5;
        while (this.coordinateCount--) { this.coordinates.push([this.x, this.y]); }
        this.angle = random(0, Math.PI * 2);
        this.speed = random(1, 10);
        this.friction = 0.96; 
        this.gravity = 0.5;   
        this.hue = random(hue - 50, hue + 50);
        this.brightness = random(50, 80);
        this.alpha = 1;
        this.decay = random(0.001, 0.004); 
    }

    Particle.prototype.update = function(index) {
        this.coordinates.pop();
        this.coordinates.unshift([this.x, this.y]);
        this.speed *= this.friction;
        this.x += Math.cos(this.angle) * this.speed;
        this.y += Math.sin(this.angle) * this.speed + this.gravity;
        this.alpha -= this.decay;
        if (this.alpha <= this.decay) { particles.splice(index, 1); }
    }

    Particle.prototype.draw = function() {
        ctx.beginPath();
        ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
        ctx.lineTo(this.x, this.y);
        ctx.strokeStyle = 'hsla(' + this.hue + ', 100%, ' + this.brightness + '%, ' + this.alpha + ')';
        ctx.stroke();
    }

    function createParticles(x, y) {
        var particleCount = 50;
        while (particleCount--) { particles.push(new Particle(x, y)); }
    }

    // --- HÀM TẠO HÌNH DÁNG ---
    function createShapeParticles(x, y, points) {
        for (var i = 0; i < points.length; i++) {
            var p = new Particle(x, y);
            p.x = x + points[i].x;
            p.y = y + points[i].y;
            p.speed = 0.1; 
            p.coordinates = [];
            var coordCount = 5;
            while (coordCount--) { p.coordinates.push([p.x, p.y]); }
            particles.push(p);
        }
    }

    function getHeartPoints(scale) {
        var points = [];
        for (var t = 0; t < Math.PI * 2; t += 0.1) {
            var hx = 16 * Math.pow(Math.sin(t), 3);
            var hy = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
            points.push({x: hx * scale, y: -hy * scale});
        }
        return points;
    }

    function getTextPoints(text, fontSize) {
        var hiddenCanvas = document.createElement('canvas');
        var hiddenCtx = hiddenCanvas.getContext('2d');
        hiddenCanvas.width = 800;
        hiddenCanvas.height = fontSize * 2;
        hiddenCtx.font = 'bold ' + fontSize + 'px Arial, sans-serif';
        hiddenCtx.fillStyle = '#FFF';
        hiddenCtx.textAlign = 'center';
        hiddenCtx.textBaseline = 'middle';
        hiddenCtx.fillText(text, hiddenCanvas.width / 2, hiddenCanvas.height / 2);

        var imageData = hiddenCtx.getImageData(0, 0, hiddenCanvas.width, hiddenCanvas.height);
        var data = imageData.data;
        var points = [];
        for (var i = 0; i < data.length; i += 4 * 3) {
            if (data[i + 3] > 128) {
                var px = (i / 4) % hiddenCanvas.width;
                var py = Math.floor((i / 4) / hiddenCanvas.width);
                points.push({x: px - hiddenCanvas.width / 2, y: py - hiddenCanvas.height / 2});
            }
        }
        return points;
    }

    // --- VÒNG LẶP CHÍNH ---
    function loop() {
        requestAnimFrame(loop);
        hue += 0.5;

        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.fillRect(0, 0, cw, ch);
        ctx.globalCompositeOperation = 'lighter';

        var i = fireworks.length;
        while (i--) {
            fireworks[i].draw();
            fireworks[i].update(i);
        }

        var i = particles.length;
        while (i--) {
            particles[i].draw();
            particles[i].update(i);
        }

        // --- ĐIỀU CHỈNH TỶ LỆ TẠI ĐÂY ---
        if (timerTick >= timerTotal) {
            if (!mousedown) {
                var chance = random(0, 100);
                var shape = null;
                
                // Tỷ lệ: 20% Chữ - 20% Tim - 60% Thường
                if (chance > 80) { 
                    shape = 'text'; // 20% (từ 80-100)
                } else if (chance > 60) {
                    shape = 'heart'; // 20% (từ 60-80)
                }
                // 60% còn lại là mặc định

                var targetX = shape === 'text' ? cw / 2 : random(0, cw);
                var targetY = shape === 'text' ? ch / 3 : random(0, ch / 2);

                fireworks.push(new Firework(cw / 2, ch, targetX, targetY, shape));
                timerTick = 0;
            }
        } else {
            timerTick++;
        }

        if (limiterTick >= limiterTotal) {
            if (mousedown) {
                fireworks.push(new Firework(cw / 2, ch, mx, my));
                limiterTick = 0;
            }
        } else {
            limiterTick++;
        }
    }

    canvas.addEventListener('mousemove', function(e) {
        mx = e.pageX - canvas.offsetLeft;
        my = e.pageY - canvas.offsetTop;
    });
    canvas.addEventListener('mousedown', function(e) {
        e.preventDefault();
        mousedown = true;
    });
    canvas.addEventListener('mouseup', function(e) {
        e.preventDefault();
        mousedown = false;
    });

    window.onload = loop;
</script>
</body>
</html>